@page "/chat/{roomId?}"
@page "/"
@using Netrunner.Shared.Chat
@inject HttpClient Http

@if (!string.IsNullOrWhiteSpace(RoomId))
{
    <Chat RoomId=@RoomId/>
}
else
{
    @if (_invites != null)
    {
        <h5>Invitations</h5>
        <ul>
            @foreach (var roomId in _invites)
            {
                <li>
                    <button @onclick="() => HandleJoin(roomId)">Join @roomId</button>
                </li>
            }
        </ul>
    }

    <Rooms @ref="RoomsComponent"/>

    <form @onsubmit="HandleCreateRoom">
        <div class="form-group">
            <label>
                Name:
                <input @bind="_newRoomInput" size="50"/>
            </label>
        </div>
        <button>Create Room</button>
    </form>
}

@code
{
#nullable enable
    [Parameter]
    public string? RoomId { get; set; }

    protected Rooms? RoomsComponent;

    private string? _newRoomInput;
    private IEnumerable<string>? _invites;

    protected override async Task OnInitializedAsync()
    {
        _invites = await Http.GetFromJsonAsync<IEnumerable<string>>("api/v1/rooms/invites");
    }

    private async Task HandleCreateRoom()
    {
        await Http.PostAsJsonAsync("api/v1/rooms", new CreateChatRoom
        {
            Name = _newRoomInput
        });
        _newRoomInput = null;

        if (RoomsComponent != null)
            await RoomsComponent.Refresh();
    }

    private async Task HandleJoin(string roomId)
    {
        await Http.PostAsync($"api/v1/rooms/join/{roomId}", null!);

        if (RoomsComponent != null)
            await RoomsComponent.Refresh();
    }

}